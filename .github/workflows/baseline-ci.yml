name: Baseline CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect repository content
        id: detect
        run: |
          set -euo pipefail
          if git ls-files '*.tf' | grep -q .; then echo "has_tf=true" >> "$GITHUB_OUTPUT"; else echo "has_tf=false" >> "$GITHUB_OUTPUT"; fi
          if git ls-files '*.py' | grep -q .; then echo "has_py=true" >> "$GITHUB_OUTPUT"; else echo "has_py=false" >> "$GITHUB_OUTPUT"; fi
          if git ls-files '*.sh' | grep -q .; then echo "has_sh=true" >> "$GITHUB_OUTPUT"; else echo "has_sh=false" >> "$GITHUB_OUTPUT"; fi

      - name: Setup Terraform
        if: steps.detect.outputs.has_tf == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Terraform fmt check
        if: steps.detect.outputs.has_tf == 'true'
        run: terraform fmt -check -recursive

      - name: Terraform validate (best effort)
        if: steps.detect.outputs.has_tf == 'true'
        run: |
          set -euo pipefail
          mapfile -t dirs < <(git ls-files '*.tf' | xargs -n1 dirname | sort -u)
          for d in "${dirs[@]}"; do
            terraform -chdir="$d" init -backend=false >/dev/null || true
            terraform -chdir="$d" validate || true
          done

      - name: Python syntax validation
        if: steps.detect.outputs.has_py == 'true'
        run: python -m compileall -q .

      - name: Shell syntax validation
        if: steps.detect.outputs.has_sh == 'true'
        run: |
          set -euo pipefail
          git ls-files '*.sh' | while read -r f; do
            bash -n "$f"
          done
